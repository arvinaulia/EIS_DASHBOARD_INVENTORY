"
-- query inventory terbaru

SELECT 
--DATAAREA.NAME as UNITKERJA, 
--DATAAREA.ID AS KODEUNIT, 
FACT.DATEFINANCIAL as date,
22 as company_id,
INVENTITEMSUPERGROUP.ITEMSUPERGROUPID AS product_category_id,
INVENTITEMSUPERGROUP.NAME AS product_category_name,
--INVENTTABLE.ITEMGROUPID AS subproduct_category_id,
CASE WHEN LEN(INVENTTABLE.ITEMGROUPID) = 8 THEN INVENTTABLE.ITEMGROUPID+'-00'
	WHEN INVENTTABLE.ITEMGROUPID = 'OC PENY. ALAT PROD' THEN 'OC PENY ALAT PROD'
		ELSE INVENTTABLE.ITEMGROUPID END AS [subproduct_category_id],
REPLACE(REPLACE(REPLACE(REPLACE(convert(nvarchar,INVENTITEMGROUP.NAME)    ,'.','') ,'/',''),')',''),'(','')AS subproduct_category_name,
CASE WHEN INVENTDIM.CONFIGID = '' THEN '-'
	WHEN INVENTDIM.CONFIGID like '%.' THEN REPLACE(convert(nvarchar,INVENTDIM.CONFIGID)    ,'.','')
	ELSE INVENTDIM.CONFIGID END AS class_id,
CASE WHEN INVENTDIM.CONFIGID = '' THEN '-'
	WHEN INVENTDIM.CONFIGID like '%.' THEN REPLACE(convert(nvarchar,INVENTDIM.CONFIGID)    ,'.','')
	ELSE INVENTDIM.CONFIGID END AS class_name,
INVENTTABLE.ITEMID as product_id,
REPLACE(REPLACE(REPLACE(REPLACE(convert(nvarchar,INVENTTABLE.ITEMNAME)    ,'(',''),')',''),'X-',''),'-X','') AS product_name,
--INVENTTABLE.ITEMNAME as product_name,
INVENTTABLEMODULE.UNITID AS product_uom,
--INVENTTRANS.DATEFINANCIAL AS date,
--INVENTTABLE.DIMGROUPID,  
sum(FACT.RUPIAH) AS VALUE,
sum(FACT.KUANTUM) AS QTY,

CASE WHEN sum(FACT.KUANTUM)= 0 THEN 0
		ELSE  sum(FACT.RUPIAH)/sum(FACT.KUANTUM) END AS [unit_price],
INVENTTABLE.DIMGROUPID AS [group_category]
FROM  (
				SELECT DATAAREAID, ITEMID, INVENTDIMID, SUM(QTY) AS KUANTUM, SUM(COSTAMOUNTPOSTED + COSTAMOUNTADJUSTMENT) AS RUPIAH, 
                              '1) SALDO AWAL' AS TIPE, DATEFINANCIAL
               FROM   INVENTTRANS
               WHERE (DateFinancial < DATEADD(mm, DATEDIFF(mm, 0, GETDATE()), 0))   AND (STATUSISSUE=1 OR STATUSRECEIPT=1) -- status issue 1 sold, ststus receipt 1 = purchased
               GROUP BY DATAAREAID, ITEMID, INVENTDIMID, DATEFINANCIAL
               
               UNION ALL
               
               SELECT DATAAREAID, ITEMID, INVENTDIMID, QTY AS KUANTUM, (COSTAMOUNTPOSTED + COSTAMOUNTADJUSTMENT) AS RUPIAH, 
                              '2) PENAMBAHAN' AS TIPE, DATEFINANCIAL
               FROM  INVENTTRANS AS INVENTTRANS_2
               WHERE (DateFinancial BETWEEN DATEADD(mm, DATEDIFF(mm, 0, GETDATE()), 0) AND  GETDATE())   AND (QTY > 0) AND (STATUSRECEIPT=1)
               
               UNION ALL
               
               SELECT DATAAREAID, ITEMID, INVENTDIMID, QTY AS KUANTUM, (COSTAMOUNTPOSTED + COSTAMOUNTADJUSTMENT) AS RUPIAH, 
                              '3) PENGURANGAN' AS TIPE, DATEFINANCIAL
               FROM  INVENTTRANS AS INVENTTRANS_1
               WHERE (DateFinancial BETWEEN DATEADD(mm, DATEDIFF(mm, 0, GETDATE()), 0) AND   GETDATE())   AND (QTY < 0) AND (STATUSISSUE=1)
               ) AS FACT INNER JOIN
               INVENTDIM ON FACT.INVENTDIMID = INVENTDIM.INVENTDIMID INNER JOIN
              INVENTTABLE ON FACT.ITEMID = INVENTTABLE.ITEMID INNER JOIN --AND INVENTTABLE.DIMGROUPID in (@DimGroup) INNER JOIN 
             INVENTITEMGROUP ON INVENTTABLE.ITEMGROUPID = INVENTITEMGROUP.ITEMGROUPID INNER JOIN
             INVENTITEMSUPERGROUP ON INVENTITEMGROUP.ITEMSUPERGROUPID = INVENTITEMSUPERGROUP.ITEMSUPERGROUPID INNER JOIN
             INVENTTABLEMODULE ON INVENTTABLE.ITEMID = INVENTTABLEMODULE.ITEMID INNER JOIN
               --AND (INVENTTABLE.ITEMTYPE <> 2) 
               DATAAREA ON FACT.DATAAREAID = DATAAREA.ID


WHERE (INVENTDIM.DATAAREAID = N'virt') AND (INVENTTABLE.DATAAREAID = N'virt') AND (INVENTITEMGROUP.DATAAREAID = N'virt') AND (INVENTITEMSUPERGROUP.DATAAREAID = N'virt') AND (INVENTTABLEMODULE.DATAAREAID = N'virt') AND (INVENTTABLEMODULE.MODULETYPE = '0')
AND FACT.DATEFINANCIAL= '"+((String)globalMap.get("ymd"))+"'
--AND LEFT(CONVERT(varchar,FACT.DATEFINANCIAL,112),6)= '"+((String)globalMap.get("ym"))+"'  -- ambil month to date

GROUP BY DATAAREA.NAME, 
DATAAREA.ID, 
FACT.DATEFINANCIAL ,
INVENTITEMSUPERGROUP.ITEMSUPERGROUPID,
INVENTITEMSUPERGROUP.NAME ,
--INVENTTABLE.ITEMGROUPID,
CASE WHEN LEN(INVENTTABLE.ITEMGROUPID) = 8 THEN INVENTTABLE.ITEMGROUPID+'-00'
	WHEN INVENTTABLE.ITEMGROUPID = 'OC PENY. ALAT PROD' THEN 'OC PENY ALAT PROD'
		ELSE INVENTTABLE.ITEMGROUPID END,REPLACE(REPLACE(REPLACE(REPLACE(convert(nvarchar,INVENTITEMGROUP.NAME)    ,'.','') ,'/',''),')',''),'(',''),
CASE WHEN INVENTDIM.CONFIGID = '' THEN '-'
	WHEN INVENTDIM.CONFIGID like '%.' THEN REPLACE(convert(nvarchar,INVENTDIM.CONFIGID)    ,'.','')
	ELSE INVENTDIM.CONFIGID END,
CASE WHEN INVENTDIM.CONFIGID = '' THEN '-'
	WHEN INVENTDIM.CONFIGID like '%.' THEN REPLACE(convert(nvarchar,INVENTDIM.CONFIGID)    ,'.','')
	ELSE INVENTDIM.CONFIGID END ,
INVENTTABLE.ITEMID,
INVENTTABLE.ITEMNAME,
INVENTTABLEMODULE.UNITID 
--INVENTTRANS.DATEFINANCIAL AS date,
--INVENTTABLE.DIMGROUPID, 
ORDER BY ID





"
